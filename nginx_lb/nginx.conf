# nginx_lb/nginx.conf (ĐÃ SỬA LỖI CÚ PHÁP)

# 1. FRONTEND UPSTREAM
upstream frontend_app {
    server frontend:3000; 
}

# 2. AUTH UPSTREAM (IP Hash)
upstream auth_servers {
    ip_hash;
    server backend-web1:3001; 
    server backend-web2:3001;
    server backend-web3:3001;
}

# 3. PRODUCT UPSTREAM (Least Connection)
upstream product_servers {
    least_conn; 
    server backend-web1:3001;
    server backend-web2:3001;
    server backend-web3:3001;
}

# 4. ORDER/CART UPSTREAM (Weighted RR)
upstream cart_order_servers {
    server backend-web1:3001 weight=5; 
    server backend-web2:3001 weight=3;
    server backend-web3:3001 weight=2;
}


server {
    listen 80;

    # ROUTE 1: Auth & User (IP Hash)
    location ~ ^/(auth|users)/ {
        proxy_pass http://auth_servers; 
        proxy_set_header Host $host;
    }

    # ROUTE 2: Products, Categories, Upload (Least Connection)
    location ~ ^/(products|categories|upload)/ { 
        proxy_pass http://product_servers;
        proxy_set_header Host $host;
    }

    # ROUTE 3: Cart & Orders (Weighted RR)
    location ~ ^/(cart|orders)/ {
        proxy_pass http://cart_order_servers;
        proxy_set_header Host $host;
    }

    # ROUTE 4: Fallback cho Frontend (TẤT CẢ các URL khác)
    location / {
        proxy_pass http://frontend_app;
        proxy_set_header Host $host;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }
}