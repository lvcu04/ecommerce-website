# nginx_lb/nginx.conf (BỎ HẾT KHỐI EVENTS VÀ KHỐI HTTP)

# 1. AUTH UPSTREAM: Cần Session Affinity (IP Hash)
upstream auth_servers {
    ip_hash;
    server backend-web1:3001; 
    server backend-web2:3001;
    server backend-web3:3001;
}

# 2. PRODUCT UPSTREAM: Cần hiệu suất tối đa (Least Connection)
upstream product_servers {
    least_conn; 
    server backend-web1:3001;
    server backend-web2:3001;
    server backend-web3:3001;
}

# 3. ORDER/CART UPSTREAM: Tác vụ giao dịch (Weighted Round Robin)
upstream cart_order_servers {
    server backend-web1:3001 weight=5; 
    server backend-web2:3001 weight=3;
    server backend-web3:3001 weight=2;
}

server {
    listen 80;

   # Định tuyến 1: Auth & User
    location ~ ^/(auth|users)/ {
        proxy_pass http://auth_servers; # THÊM DẤU / Ở CUỐI
        proxy_set_header Host $host;
    }

    # Định tuyến 2: Products & Categories
    location ~ ^/(products|categories)/ {
        proxy_pass http://product_servers; # THÊM DẤU / Ở CUỐI
        proxy_set_header Host $host;
    }

    # Định tuyến 3: Cart & Orders
    location ~ ^/(cart|orders)/ {
        proxy_pass http://cart_order_servers; # THÊM DẤU / Ở CUỐI
        proxy_set_header Host $host;
    }

    # Định tuyến Mặc định
    location / {
        return 404 "Error: Endpoint not handled by Load Balancer rules.";
    }
}